// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

model Organization {
  id             String          @id @default(cuid())
  name           String
  domain         String?         @unique
  npi            String?         // Added NPI for billing/forms
  users          User[]
  contacts       Contact[]
  deals          Deal[]
  tasks          Task[]
  activities     Activity[]
  documents      Document[]
  messages       Message[]
  faxes          Fax[]
  visits         Visit[]
  authorizations Authorization[]
  carePlans      CarePlan[]
  assessments    Assessment[]
  forms          Form[]
  invoices       Invoice[]
  claims         Claim[]
  sandataConfig  SandataConfig?
  moduleConfig   ModuleConfig?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model User {
  id                  String          @id @default(cuid())
  email               String          @unique
  name                String?
  organizationId      String?
  organization        Organization?   @relation(fields: [organizationId], references: [id])
  contacts            Contact[]
  messages            Message[]
  faxes               Fax[]
  tasks               Task[]
  activities          Activity[]
  documents           Document[]
  emailAccounts       EmailAccount[]
  sipAccount          SipAccount?
  caregiverVisits     Visit[]
  certifications      Certification[]
  assessments         Assessment[]
  role                String          @default("USER") // ADMIN, NURSE, CAREGIVER, OFFICE, USER
  nationalProviderId  String?
  providerSSN         String?
  certificationStatus String?         @default("UP_TO_DATE")
  hourlyRate          Float?          @default(20.00)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
}

model ModuleConfig {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  crmEnabled     Boolean      @default(true)
  emailEnabled   Boolean      @default(true)
  voipEnabled    Boolean      @default(true)
  faxEnabled     Boolean      @default(true)
  storageEnabled Boolean      @default(true)
  evvEnabled     Boolean      @default(true)
  payrollEnabled Boolean      @default(true)
  auditEnabled   Boolean      @default(true)
  formsEnabled   Boolean      @default(true)
  dashboardLayout String?     @default("default") // JSON string for widget layout
}

model EmailAccount {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  imapHost  String
  imapPort  Int
  smtpHost  String
  smtpPort  Int
  username  String
  password  String // Encrypted
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SRFaxConfig {
  id        String   @id @default(cuid())
  userId    String   @unique
  accountId String
  password  String // Encrypted
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SipAccount {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id])
  username     String
  password     String // Encrypted
  domain       String
  websocketUrl String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Contact {
  id             String          @id @default(cuid())
  firstName      String
  lastName       String
  email          String?
  phone          String?
  company        String?
  status         String          @default("LEAD") // LEAD, CUSTOMER, PARTNER
  encryptedData  String? // For sensitive info, encrypted at app layer
  organizationId String?
  organization   Organization?   @relation(fields: [organizationId], references: [id])
  userId         String
  user           User            @relation(fields: [userId], references: [id])
  deals          Deal[]
  tasks          Task[]
  activities     Activity[]
  clientVisits   Visit[]
  authorizations Authorization[]
  carePlans      CarePlan[]
  assessments    Assessment[]
  documents      Document[]
  medicaidId     String?
  dateOfBirth    DateTime?
  admissionDate  DateTime?
  dischargeDate  DateTime?
  address        String?
  city           String?
  state          String?
  zip            String?
  invoices       Invoice[]
  claims         Claim[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model Deal {
  id             String        @id @default(cuid())
  title          String
  value          Float
  stage          String        @default("PROSPECTING")
  contactId      String
  contact        Contact       @relation(fields: [contactId], references: [id])
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  tasks          Task[]
  activities     Activity[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Task {
  id             String        @id @default(cuid())
  title          String
  description    String?
  status         String        @default("OPEN")
  priority       String        @default("NORMAL")
  dueDate        DateTime?
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  contactId      String?
  contact        Contact?      @relation(fields: [contactId], references: [id])
  dealId         String?
  deal           Deal?         @relation(fields: [dealId], references: [id])
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Activity {
  id             String        @id @default(cuid())
  type           String
  content        String
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  contactId      String?
  contact        Contact?      @relation(fields: [contactId], references: [id])
  dealId         String?
  deal           Deal?         @relation(fields: [dealId], references: [id])
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  createdAt      DateTime      @default(now())
}

model Message {
  id             String        @id @default(cuid())
  type           String
  direction      String
  status         String
  content        String?
  duration       Int?
  from           String
  to             String
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  createdAt      DateTime      @default(now())
}

model Fax {
  id             String        @id @default(cuid())
  direction      String
  status         String
  sender         String
  recipient      String
  fileUrl        String?
  remoteJobId    String? // Tracking ID from SRFax
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  createdAt      DateTime      @default(now())
}

model Document {
  id             String        @id @default(cuid())
  name           String
  fileUrl        String?
  size           Int           @default(0)
  type           String
  isFolder       Boolean       @default(false)
  isStarred      Boolean       @default(false)
  parentId       String?
  parent         Document?     @relation("FolderHierarchy", fields: [parentId], references: [id])
  children       Document[]    @relation("FolderHierarchy")
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  contactId      String?
  contact        Contact?      @relation(fields: [contactId], references: [id])
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model SandataConfig {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  agencyId       String
  username       String
  password       String
  providerId     String?
  environment    String       @default("TEST") // TEST, PROD
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Visit {
  id             String       @id @default(cuid())
  caregiverId    String
  caregiver      User         @relation(fields: [caregiverId], references: [id])
  clientId       String
  client         Contact      @relation(fields: [clientId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  serviceType   String
  startDateTime DateTime
  endDateTime   DateTime?

  startLatitude  Float?
  startLongitude Float?
  endLatitude    Float?
  endLongitude   Float?

  status               String  @default("IN_PROGRESS") // SCHEDULED, IN_PROGRESS, COMPLETED, VERIFIED, REJECTED, SUBMITTED
  sandataTransactionId String?

  notes           String?
  clientSignature String? // Base64 signature if captured

  completedTasks VisitTask[]

  // Billing Relations
  invoiceItems   InvoiceItem[]
  claimId        String?
  claim          Claim?        @relation(fields: [claimId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Authorization {
  id             String       @id @default(cuid())
  contactId      String
  contact        Contact      @relation(fields: [contactId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  authNumber  String
  serviceCode String
  startDate   DateTime
  endDate     DateTime
  totalUnits  Float
  usedUnits   Float    @default(0)
  status      String   @default("ACTIVE") // ACTIVE, EXPIRED, EXHAUSTED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CarePlan {
  id             String       @id @default(cuid())
  contactId      String
  contact        Contact      @relation(fields: [contactId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  title       String
  description String?
  status      String         @default("ACTIVE")
  tasks       CarePlanTask[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CarePlanTask {
  id         String   @id @default(cuid())
  carePlanId String
  carePlan   CarePlan @relation(fields: [carePlanId], references: [id])

  taskName    String
  description String?
  frequency   String? // e.g., "EVERY_VISIT"
  category    String? // ADL, IADL, CLINICAL

  visitTasks VisitTask[]
}

model VisitTask {
  id      String       @id @default(cuid())
  visitId String
  visit   Visit        @relation(fields: [visitId], references: [id])
  taskId  String
  task    CarePlanTask @relation(fields: [taskId], references: [id])

  completed   Boolean   @default(false)
  comment     String?
  completedAt DateTime?
}

model Certification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  name       String // CPR, TB, Nursing License
  certNumber String?
  issueDate  DateTime?
  expiryDate DateTime?
  status     String    @default("ACTIVE")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Assessment {
  id             String       @id @default(cuid())
  contactId      String
  contact        Contact      @relation(fields: [contactId], references: [id])
  nurseId        String
  nurse          User         @relation(fields: [nurseId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  type   String // INITIAL, RECERTIFICATION, POST_HOSPITAL
  data   String // JSON blob of assessment data
  status String @default("DRAFT") // DRAFT, COMPLETED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Form {
  id             String           @id @default(cuid())
  title          String
  description    String?
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id])
  fields         FormField[]
  submissions    FormSubmission[]
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
}

model FormField {
  id          String  @id @default(cuid())
  formId      String
  form        Form    @relation(fields: [formId], references: [id])
  label       String
  type        String  // TEXT, NUMBER, DATE, SIGNATURE, SELECT
  required    Boolean @default(false)
  options     String? // Comma-separated for SELECT
  order       Int
}

model FormSubmission {
  id             String   @id @default(cuid())
  formId         String
  form           Form     @relation(fields: [formId], references: [id])
  data           String   // JSON blob of submission
  submittedById  String?
  organizationId String
  createdAt      DateTime @default(now())
}

model Invoice {
  id             String       @id @default(cuid())
  invoiceNumber  String       @unique
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  contactId      String
  contact        Contact      @relation(fields: [contactId], references: [id])
  
  date           DateTime
  dueDate        DateTime
  status         String       @default("DRAFT") // DRAFT, SENT, PAID, VOID, OVERDUE
  totalAmount    Float
  paidAmount     Float        @default(0)
  
  items          InvoiceItem[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Float    @default(1)
  unitPrice   Float
  total       Float
  
  visitId     String?
  visit       Visit?   @relation(fields: [visitId], references: [id])
}

model Claim {
  id             String       @id @default(cuid())
  claimId        String       @unique // Internal ID or Payer Claim ID
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  contactId      String
  contact        Contact      @relation(fields: [contactId], references: [id])
  
  payerName      String
  payerId        String?
  
  status         String       @default("DRAFT") // DRAFT, SUBMITTED, ACCEPTED, REJECTED, PAID, DENIED
  
  totalBilled    Float
  totalPaid      Float        @default(0)
  
  serviceDateStart DateTime
  serviceDateEnd   DateTime
  
  diagnosisCodes String // JSON array of ICD-10 codes
  
  visits         Visit[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}
